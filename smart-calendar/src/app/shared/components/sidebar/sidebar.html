<nav class="sidebar" [class.collapsed]="!isOpen" aria-label="Navegação principal">
  <!-- Header -->
  <div class="sidebar-header">
    <div class="logo" *ngIf="isOpen">
      <img src="/assets/images/Logo_dark.png"
           alt="AgendaRápido"
           class="logo-img"
           loading="lazy">
      <h2 class="logo-text">AgendaRápido</h2>
    </div>
    <div class="logo-collapsed" *ngIf="!isOpen">
      <img src="/assets/images/Logo_dark.png"
           alt="AgendaRápido"
           class="logo-img-small"
           loading="lazy">
    </div>
    <button class="toggle-btn"
            (click)="onToggleSidebar()"
            [attr.aria-label]="isOpen ? 'Recolher sidebar' : 'Expandir sidebar'"
            [attr.aria-expanded]="isOpen">
      <mat-icon>{{ isOpen ? 'chevron_left' : 'chevron_right' }}</mat-icon>
    </button>
  </div>

  <!-- Search -->
  <div class="search-section" *ngIf="isOpen">
    <div class="search-box">
      <mat-icon class="search-icon">search</mat-icon>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="onSearch()"
        (keydown.escape)="clearSearch()"
        placeholder="Buscar eventos, tarefas..."
        class="search-input"
        aria-label="Campo de busca"
        [attr.aria-describedby]="searchTerm ? 'search-results' : null"
      >
      <button mat-icon-button
              *ngIf="searchTerm"
              (click)="clearSearch()"
              class="clear-btn"
              aria-label="Limpar busca">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="search-results"
         *ngIf="searchResults.length > 0"
         id="search-results"
         role="listbox"
         aria-label="Resultados da busca">
      <div *ngFor="let result of searchResults; trackBy: trackBySearchResult"
           class="search-result-item"
           role="option"
           (click)="selectSearchResult(result)"
           (keydown.enter)="selectSearchResult(result)">
        <mat-icon class="result-icon">{{ result.type === 'event' ? 'event' : 'task_alt' }}</mat-icon>
        <div class="result-content">
          <span class="result-title">{{ result.title }}</span>
          <span class="result-meta">{{ result.date | date:'short' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="quick-stats" *ngIf="isOpen" role="region" aria-label="Estatísticas rápidas">
    <div class="stats-header">
      <h3>Resumo do Dia</h3>
      <button mat-icon-button (click)="refreshStats()" aria-label="Atualizar estatísticas">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card"
           [attr.aria-label]="'Eventos hoje: ' + stats.todayEvents"
           (click)="navigateToToday()">
        <div class="stat-icon">
          <mat-icon>today</mat-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ stats.todayEvents }}</span>
          <span class="stat-label">Eventos Hoje</span>
        </div>
      </div>

      <div class="stat-card"
           [attr.aria-label]="'Progresso: ' + getCompletionPercentage() + ' por cento'"
           (click)="navigateToTasks()">
        <div class="stat-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ getCompletionPercentage() }}%</span>
          <span class="stat-label">Completo</span>
        </div>
        <div class="stat-progress">
          <div class="progress-bar"
               [style.width.%]="getCompletionPercentage()"></div>
        </div>
      </div>

      <div class="stat-card"
           [attr.aria-label]="'Nível de foco: ' + getFocusLevel()"
           (click)="navigateToProductivity()">
        <div class="stat-icon">
          <mat-icon [style.color]="getFocusColor()">psychology</mat-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number" [style.color]="getFocusColor()">{{ getFocusLevel() }}</span>
          <span class="stat-label">Foco</span>
        </div>
      </div>

      <div class="stat-card"
           [attr.aria-label]="'Tarefas pendentes: ' + stats.pendingTasks"
           (click)="navigateToTasks()">
        <div class="stat-icon">
          <mat-icon>pending_actions</mat-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ stats.pendingTasks }}</span>
          <span class="stat-label">Pendentes</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="sidebar-nav" role="navigation" aria-label="Navegação principal">
    <div *ngFor="let item of filteredNavItems; trackBy: trackByNavItem" class="nav-group">
      <button
        class="nav-item"
        [class.active]="isActiveRoute(item.route)"
        [class.has-children]="item.children"
        (click)="item.children ? toggleSubmenu(item) : navigateTo(item.route)"
        [attr.aria-expanded]="item.children ? item.isExpanded : null"
        [attr.aria-label]="getNavItemAriaLabel(item)"
        [matTooltip]="!isOpen ? item.label : ''"
        matTooltipPosition="right"
      >
        <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
        <span class="nav-text" *ngIf="isOpen">{{ item.label }}</span>
        <span class="nav-badge"
              *ngIf="item.badge && item.badge > 0 && isOpen"
              [attr.aria-label]="item.badge + ' itens'">
          {{ item.badge > 99 ? '99+' : item.badge }}
        </span>
        <mat-icon class="nav-arrow"
                 *ngIf="item.children && isOpen"
                 [class.expanded]="item.isExpanded">
          {{ item.isExpanded ? 'expand_less' : 'expand_more' }}
        </mat-icon>
      </button>

      <!-- Submenu -->
      <div class="submenu"
           *ngIf="item.children && item.isExpanded && isOpen"
           role="group"
           [attr.aria-label]="'Submenu de ' + item.label">
        <button
          *ngFor="let child of item.children; trackBy: trackByNavItem"
          class="submenu-item"
          [class.active]="isActiveRoute(child.route)"
          (click)="navigateTo(child.route)"
          [attr.aria-label]="child.label"
        >
          <mat-icon class="submenu-icon">{{ child.icon }}</mat-icon>
          <span class="submenu-text">{{ child.label }}</span>
          <span class="submenu-badge"
                *ngIf="child.badge && child.badge > 0"
                [attr.aria-label]="child.badge + ' itens'">
            {{ child.badge > 99 ? '99+' : child.badge }}
          </span>
        </button>
      </div>
    </div>

  <!-- Notifications -->
  <div class="notifications-section"
       *ngIf="isOpen && notifications > 0"
       role="region"
       aria-label="Notificações">
    <button class="notification-header"
            (click)="openNotifications()"
            [attr.aria-label]="'Abrir ' + notifications + ' notificações'">
      <div class="notification-icon">
        <mat-icon>notifications</mat-icon>
        <span class="notification-pulse" *ngIf="hasUnreadNotifications"></span>
      </div>
      <span class="notification-text">Notificações</span>
      <span class="notification-count">{{ notifications > 99 ? '99+' : notifications }}</span>
    </button>

    <div class="recent-notifications" *ngIf="recentNotifications.length > 0">
      <div *ngFor="let notification of recentNotifications | slice:0:3; trackBy: trackByNotification"
           class="notification-item"
           [class.unread]="!notification.read"
           (click)="openNotification(notification)">
        <mat-icon class="notification-type-icon">{{ getNotificationIcon(notification.type) }}</mat-icon>
        <div class="notification-content">
          <span class="notification-title">{{ notification.title }}</span>
          <span class="notification-time">{{ notification.timestamp | date:'short' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="sidebar-footer">
    <div class="user-profile" *ngIf="isOpen">
      <div class="user-avatar"
           [style.background-image]="user.avatar ? 'url(' + user.avatar + ')' : 'none'">
        {{ !user.avatar ? (user.name?.charAt(0) || 'U') : '' }}
      </div>
      <div class="user-info">
        <strong class="user-name">{{ user.name || 'Usuário' }}</strong>
        <small class="user-email">{{ user.email || 'user@example.com' }}</small>
        <div class="user-status">
          <span class="status-indicator" [class]="getUserStatusClass()"></span>
          <span class="status-text">{{ getUserStatusText() }}</span>
        </div>
      </div>
      <button mat-icon-button
              class="user-menu-btn"
              [matMenuTriggerFor]="sidebarUserMenu"
              aria-label="Menu do usuário">
        <mat-icon>more_vert</mat-icon>
      </button>

      <mat-menu #sidebarUserMenu="matMenu">
        <button mat-menu-item (click)="openProfile()">
          <mat-icon>person</mat-icon>
          <span>Perfil</span>
        </button>
        <button mat-menu-item (click)="openSettings()">
          <mat-icon>settings</mat-icon>
          <span>Configurações</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="logout()">
          <mat-icon>logout</mat-icon>
          <span>Sair</span>
        </button>
      </mat-menu>
    </div>

    <div class="collapsed-user" *ngIf="!isOpen">
      <button mat-icon-button
              class="user-avatar-small"
              [matMenuTriggerFor]="collapsedUserMenu"
              [style.background-image]="user.avatar ? 'url(' + user.avatar + ')' : 'none'"
              [attr.aria-label]="'Menu do usuário: ' + (user.name || 'Usuário')">
        {{ !user.avatar ? (user.name?.charAt(0) || 'U') : '' }}
      </button>

      <mat-menu #collapsedUserMenu="matMenu">
        <div class="collapsed-menu-header">
          <div class="user-avatar-large"
               [style.background-image]="user.avatar ? 'url(' + user.avatar + ')' : 'none'">
            {{ !user.avatar ? (user.name?.charAt(0) || 'U') : '' }}
          </div>
          <div class="user-details">
            <strong>{{ user.name || 'Usuário' }}</strong>
            <small>{{ user.email || 'user@example.com' }}</small>
          </div>
        </div>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="openProfile()">
          <mat-icon>person</mat-icon>
          <span>Perfil</span>
        </button>
        <button mat-menu-item (click)="openSettings()">
          <mat-icon>settings</mat-icon>
          <span>Configurações</span>
        </button>
        <button mat-menu-item (click)="logout()">
          <mat-icon>logout</mat-icon>
          <span>Sair</span>
        </button>
      </mat-menu>
    </div>
  </div>
</nav>
