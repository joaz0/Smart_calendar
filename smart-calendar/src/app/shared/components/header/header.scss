@import '../../../../assets/styles/variables';
@import '../../../../assets/styles/mixins';
@import '../../../../assets/styles/breakpoints';

@keyframes badgePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes statusPulse {
  0%, 100% { box-shadow: 0 0 0 2px var(--success-50); }
  50% { box-shadow: 0 0 0 4px transparent; }
}

.app-header {
  @include flex-between;
  width: 100%;
  padding: var(--space-4) var(--space-7);
  background: rgba(var(--bg-primary-rgb), 0.8);
  backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border-primary);
  min-height: 72px;
  position: relative;
  z-index: var(--z-sticky);
  transition: all var(--transition-slow);

  &.sticky {
    position: sticky;
    top: 0;
  }

  &.scrolled {
    box-shadow: var(--shadow-lg);
    padding-top: var(--space-3);
    padding-bottom: var(--space-3);
    min-height: 64px;
    background: rgba(var(--bg-primary-rgb), 0.9);
  }

  @media (max-width: #{map-get(vars.$breakpoints, 'md') - 1px}) {
    padding: var(--space-3) var(--space-5);
    min-height: 64px;

    &.scrolled {
      padding-top: var(--space-2);
      padding-bottom: var(--space-2);
      min-height: 56px;
    }
  }
}

// --- Left Section ---
.header-left {
  @include flex-center;
  gap: var(--space-5);
  flex-shrink: 0;

  .sidebar-toggle {
    @include ghost-button;
    @include touch-target;

    @media (min-width: #{map-get(vars.$breakpoints, 'lg')}) {
      display: none;
    }
  }

  .header-logo {
    @include flex-center;
    gap: var(--space-3);
    text-decoration: none;
    transition: transform var(--transition-fast);

    img { height: 32px; width: auto; }

    .logo-text {
      font-size: var(--font-size-xl);
      font-weight: var(--font-bold);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.02em;
    }

    &:hover { transform: translateY(-1px); }

    @media (max-width: #{map-get(vars.$breakpoints, 'md') - 1px}) {
      .logo-text { display: none; }
    }
  }

  .breadcrumb {
    @include flex-center;
    gap: var(--space-2);
    font-size: var(--font-size-sm);

    @media (max-width: #{map-get(vars.$breakpoints, 'md') - 1px}) {
      display: none;
    }

    .breadcrumb-item {
      @include flex-center;
      gap: var(--space-2);
      color: var(--text-tertiary);
      text-decoration: none;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
      font-weight: var(--font-medium);

      mat-icon { font-size: var(--font-size-base); }

      &:hover:not(.current) {
        color: var(--text-primary);
        background: var(--bg-tertiary);
      }

      &.current {
        color: var(--text-primary);
        font-weight: var(--font-semibold);
        pointer-events: none;
      }
    }

    .breadcrumb-separator {
      font-size: var(--font-size-sm);
      color: var(--border-secondary);
    }
  }
}

// --- Center Section ---
.header-center {
  flex: 1;
  max-width: 560px;
  margin: 0 var(--space-8);

  @media (max-width: #{map-get(vars.$breakpoints, 'md') - 1px}) {
    display: none;
  }
  app-search-bar { width: 100%; }
}

// --- Right Section ---
.header-right {
  @include flex-center;
  gap: var(--space-2);
  flex-shrink: 0;

  .header-btn {
    @include ghost-button;
    @include touch-target;

    &.notifications-btn .notification-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      min-width: 18px;
      height: 18px;
      background: var(--gradient-danger, var(--error-500));
      color: white;
      font-size: var(--font-size-xs);
      font-weight: var(--font-bold);
      border-radius: var(--radius-full);
      @include flex-center;
      padding: 0 5px;
      box-shadow: 0 2px 6px var(--error-500);
      animation: badgePulse 2s infinite;
    }

    &.theme-toggle mat-icon {
      transition: transform var(--transition-slow);
    }

    &:hover mat-icon {
      transform: rotate(180deg);
    }
  }

  .greeting-section {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    margin-right: var(--space-3);
    padding-right: var(--space-3);
    border-right: 1px solid var(--border-primary);

    @media (max-width: #{map-get(vars.$breakpoints, 'lg') - 1px}) {
      display: none;
    }

    .greeting-text {
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
      color: var(--text-secondary);
    }

    .current-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      font-weight: var(--font-medium);
    }
  }

  .user-menu-btn {
    @include flex-center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3) var(--space-2) var(--space-2);
    border-radius: var(--radius-lg);
    background: transparent;
    border: 2px solid transparent;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition-slow);
    min-height: var(--touch-target-min);

    &:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-primary);
      transform: translateY(-1px);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      background: var(--gradient-primary);
      @include flex-center;
      font-size: var(--font-size-sm);
      font-weight: var(--font-bold);
      color: white;
      border: 2px solid var(--primary-100);
      box-shadow: 0 2px 8px var(--primary-200);
      flex-shrink: 0;
      position: relative;
      transition: transform var(--transition-slow);

      img {
        width: 100%;
        height: 100%;
        border-radius: var(--radius-full);
        object-fit: cover;
      }

      .user-status {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        border-radius: var(--radius-full);
        border: 2px solid var(--bg-secondary);

        &.online { background: var(--success-500); animation: statusPulse 2s infinite; }
        &.away { background: var(--warning-500); }
        &.busy { background: var(--error-500); }
        &.offline { background: var(--gray-500); }
      }
    }

    &:hover .user-avatar { transform: scale(1.05); }

    .user-info {
      @include flex-column;
      align-items: flex-start;
      min-width: 0;

      @media (max-width: #{map-get(vars.$breakpoints, 'md') - 1px}) { display: none; }

      .user-name, .user-role {
        @include truncate;
        max-width: 120px;
      }
      .user-name {
        font-size: var(--font-size-sm);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
      }
      .user-role {
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
      }
    }

    mat-icon {
      font-size: var(--font-size-lg);
      color: var(--text-tertiary);
      transition: transform var(--transition-slow);
      @media (max-width: #{map-get(vars.$breakpoints, 'md') - 1px}) { display: none; }
    }

    &:hover mat-icon { transform: rotate(180deg); }
  }
}

// --- Menu Panels ---
// Use ::ng-deep to pierce component encapsulation for Angular Material.
::ng-deep {
  .mat-menu-panel.user-menu,
  .mat-menu-panel.notifications-panel {
    @include elevated-card;
    margin-top: var(--space-2);
    max-width: 380px;

    .mat-menu-content {
      padding: var(--space-2) !important;
    }
  }

  .user-menu {
    min-width: 240px;
    .user-menu-header {
      @include flex-center;
      gap: var(--space-3);
      padding: var(--space-4);
      margin-bottom: var(--space-2);
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);

      .user-avatar-large {
        width: 48px;
        height: 48px;
        // Styles similar to .user-avatar, can be mixin
      }

      .user-details {
        flex: 1;
        min-width: 0;
        strong, small {
          @include truncate;
          display: block;
        }
        strong {
          font-size: var(--font-size-base);
          font-weight: var(--font-bold);
          color: var(--text-primary);
          margin-bottom: var(--space-1);
        }
        small {
          font-size: var(--font-size-sm);
          color: var(--text-secondary);
        }
      }
    }
    .mat-menu-item {
      // Refactor with mixins
    }
    .mat-divider {
      margin: var(--space-2) 0 !important;
      border-color: var(--border-primary) !important;
    }
  }

  .notifications-panel {
    .notifications-header {
      // styles
    }
    .notifications-list {
      // styles
    }
  }
}

// Responsive Overrides
@media (max-width: #{map-get(vars.$breakpoints, 'md') - 1px}) {
  .app-header .header-right {
    gap: var(--space-1);
    .theme-toggle, .quick-actions-btn { display: none; }
  }
}

@media (max-width: #{map-get(vars.$breakpoints, 'sm')}) {
  .app-header {
    padding: var(--space-3) var(--space-4);
    .header-right {
      .header-btn { @include touch-target; }
      .user-menu-btn {
        padding: var(--space-1);
        .user-avatar { width: 32px; height: 32px; font-size: var(--font-size-xs); }
      }
    }
  }
}
