<h2 mat-dialog-title>{{ isEditing ? 'Editar Evento' : 'Novo Evento' }}</h2>

<form [formGroup]="eventForm" (ngSubmit)="onSubmit()">
  <mat-dialog-content>
    <div class="form-grid">
      <mat-form-field appearance="fill">
        <mat-label>Título</mat-label>
        <input matInput formControlName="title" placeholder="Digite o título do evento">
        <mat-error *ngIf="eventForm.get('title')?.hasError('required')">
          Título é obrigatório
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Descrição</mat-label>
        <textarea matInput formControlName="description"
                  placeholder="Adicione uma descrição"></textarea>
      </mat-form-field>

      <div class="date-time-group">
        <mat-form-field appearance="fill">
          <mat-label>Data de Início</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
          <mat-error *ngIf="eventForm.get('startDate')?.hasError('required')">
            Data de início é obrigatória
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Hora de Início</mat-label>
          <input matInput type="time" [ngModel]="getTimeFromDate(eventForm.get('startDate')?.value)"
                 (ngModelChange)="updateStartTime($event)" [ngModelOptions]="{standalone: true}">
        </mat-form-field>
      </div>

      <div class="date-time-group">
        <mat-form-field appearance="fill">
          <mat-label>Data de Término</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
          <mat-error *ngIf="eventForm.get('endDate')?.hasError('required')">
            Data de término é obrigatória
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Hora de Término</mat-label>
          <input matInput type="time" [ngModel]="getTimeFromDate(eventForm.get('endDate')?.value)"
                 (ngModelChange)="updateEndTime($event)" [ngModelOptions]="{standalone: true}">
        </mat-form-field>
      </div>

      <mat-form-field appearance="fill">
        <mat-label>Local</mat-label>
        <input matInput formControlName="location" placeholder="Adicione um local">
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Categoria</mat-label>
        <mat-select formControlName="category">
          <mat-option *ngFor="let category of categories" [value]="category">
            {{ category.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <div class="recurrence-group">
        <mat-checkbox formControlName="isRecurring">Evento Recorrente</mat-checkbox>

        <mat-form-field appearance="fill" *ngIf="eventForm.get('isRecurring')?.value">
          <mat-label>Padrão de Recorrência</mat-label>
          <mat-select formControlName="recurrence">
            <mat-option value="daily">Diariamente</mat-option>
            <mat-option value="weekly">Semanalmente</mat-option>
            <mat-option value="monthly">Mensalmente</mat-option>
            <mat-option value="yearly">Anualmente</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="reminders-section" formArrayName="reminders">
        <h3>Lembretes</h3>
        <button type="button" mat-stroked-button (click)="addReminder()">
          <mat-icon>add_alarm</mat-icon>
          Adicionar Lembrete
        </button>

        <div *ngFor="let reminder of remindersFormArray.controls; let i=index"
             [formGroupName]="i" class="reminder-item">
          <mat-form-field appearance="fill">
            <mat-label>Tempo</mat-label>
            <input matInput type="number" formControlName="time">
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Unidade</mat-label>
            <mat-select formControlName="unit">
              <mat-option value="minutes">Minutos</mat-option>
              <mat-option value="hours">Horas</mat-option>
              <mat-option value="days">Dias</mat-option>
            </mat-select>
          </mat-form-field>

          <button type="button" mat-icon-button color="warn" (click)="removeReminder(i)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button type="button" mat-button (click)="onCancel()">Cancelar</button>
    <button type="button" mat-button color="warn" *ngIf="isEditing" (click)="onDelete()">
      Excluir
    </button>
    <button type="submit" mat-raised-button color="primary" [disabled]="eventForm.invalid">
      {{ isEditing ? 'Salvar' : 'Criar' }}
    </button>
  </mat-dialog-actions>
</form>
